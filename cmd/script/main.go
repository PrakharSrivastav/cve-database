package main

import (
	"context"
	"encoding/json"
	"github.com/PrakharSrivastav/cve-database/store"
	"log/slog"
	"os"
)

var (
	runId        = "1"
	jsonFilePath = "data/cve.1.json"
)

func main() {
	db, err := store.New()
	if err != nil {
		slog.Error("store.create.error", "error", err)
		return
	}
	slog.Info("store.connection.ok")

	file, err := os.ReadFile(jsonFilePath)
	if err != nil {
		slog.Error("file.read.error", err)
		return
	}

	var fileContent []CVERecord

	err = json.Unmarshal(file, &fileContent)
	if err != nil {
		slog.Error("json.unmarshal.error", err)
		return
	}

	ctx := context.Background()

	for _, j := range fileContent {
		if err = db.InsertCVEDatabase(ctx, j.toDbEntity(runId)); err != nil {
			slog.Error("insert.db.error", err)
			return
		}
	}
	slog.Info("data.stored.successfully")

}
